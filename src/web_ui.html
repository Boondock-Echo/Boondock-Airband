<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boondock Airband Capture</title>
    <link rel="stylesheet" href="/web_ui.css">
</head>
<body>
    <div class="header">
        <button id="apply-changes-btn" class="apply-changes-btn" onclick="applyChanges()" disabled>Apply Changes</button>
        <div class="nav">
            <a href="#" class="nav-link active" data-page="home">Home</a>
            <a href="#" class="nav-link" data-page="recordings">Recordings</a>
            <a href="#" class="nav-link" data-page="device">Device</a>
            <a href="#" class="nav-link" data-page="channels">Channels</a>
            <a href="#" class="nav-link" data-page="outputs">Outputs</a>
            <a href="#" class="nav-link" data-page="config">Config</a>
            <a href="#" class="nav-link" data-page="spectrum">Spectrum</a>
        </div>
    </div>
    <div class="container">
        <div id="page-home" class="page">
            <div class="metrics">
                <div class="metric">
                    <h3>Today's Recordings</h3>
                    <div class="value" id="recordings-count">0</div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">Uptime: <span id="uptime">0s</span></div>
                </div>
                <div class="metric">
                    <h3>CPU Usage</h3>
                    <div class="value" id="cpu-usage">0%</div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">Avg: <span id="cpu-avg">0%</span></div>
                </div>
                <div class="metric">
                    <h3>Disk Usage</h3>
                    <div class="value" id="disk-usage">0 GB</div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">Total: <span id="disk-total">0 GB</span></div>
                </div>
                <div class="metric">
                    <h3>RAM Usage</h3>
                    <div class="value" id="ram-usage">0%</div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">Avg: <span id="ram-avg">0%</span></div>
                </div>
            </div>
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h2>Channel Status</h2>
                    <button class="btn btn-primary" onclick="showColumnSelector()" style="font-size: 12px; padding: 5px 10px;">⚙️ View</button>
                </div>
                <table id="channels-table">
                    <thead>
                        <tr>
                            <th data-col="name" class="col-toggle">CHANNEL NAME</th>
                            <th data-col="freq" class="col-toggle">FREQ</th>
                            <th data-col="ch" class="col-toggle">CH#</th>
                            <th data-col="udp" class="col-toggle">UDP</th>
                            <th data-col="signal" class="col-toggle">SIG</th>
                            <th data-col="noise" class="col-toggle">NOISE</th>
                            <th data-col="squelch" class="col-toggle">SQL</th>
                            <th data-col="snr" class="col-toggle">SNR</th>
                            <th data-col="strength" class="col-toggle">STR</th>
                            <th data-col="ctcss" class="col-toggle">CTCSS</th>
                            <th data-col="rec" class="col-toggle">REC</th>
                        </tr>
                    </thead>
                    <tbody id="channels-tbody"></tbody>
                </table>
                <div style="margin-top: 10px; font-size: 14px; color: #666;">
                    <span id="channels-count">0</span> channels | <span id="service-status">Running</span> | Polling every 1s
                </div>
            </div>
            
            <!-- Column Selector Modal -->
            <div id="column-selector-modal" class="modal" style="display: none;" onclick="if(event.target === this) closeColumnSelector();">
                <div class="modal-content" style="max-width: 400px;" onclick="event.stopPropagation();">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>Select Columns</h3>
                        <span onclick="closeColumnSelector()" style="cursor: pointer; font-size: 24px; color: #999;">&times;</span>
                    </div>
                    <div id="column-checkboxes" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="applyColumnSelection()">Apply</button>
                        <button class="btn btn-secondary" onclick="resetColumnSelection()">Reset</button>
                        <button class="btn btn-secondary" onclick="closeColumnSelector()">Cancel</button>
                    </div>
                </div>
            </div>
            <div class="card" id="errors-card" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h2 style="color: #dc3545;">Errors</h2>
                    <button class="btn btn-primary" onclick="clearErrors()">Clear</button>
                </div>
                <div id="errors-list" style="max-height: 300px; overflow-y: auto; background: #f8f8f8; padding: 10px; border-radius: 4px;">
                    <p style="color: #666; font-style: italic;">No errors</p>
                </div>
            </div>
        </div>
        <div id="page-recordings" class="page hidden">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Recordings</h2>
                    <button class="btn btn-primary" onclick="refreshRecordings()">Refresh</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Datetime</th>
                            <th>Size</th>
                            <th>Channel</th>
                            <th>Play</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="recordings-tbody"></tbody>
                </table>
            </div>
        </div>
        <div id="page-device" class="page hidden">
            <div class="card">
                <h2>Device Configuration</h2>
                <form id="device-form" onsubmit="saveDevice(event)" onchange="markChange('device')">
                    <div class="form-group">
                        <label><input type="checkbox" id="device-disable" name="disable"> Disable Device</label>
                        <small>When enabled, this device will be ignored during configuration parsing.</small>
                    </div>
                    <div class="form-group">
                        <label>Device Type *</label>
                        <select id="device-type" name="type" onchange="updateDeviceFields()" required>
                            <option value="soapysdr">SoapySDR</option>
                            <option value="rtlsdr">RTL-SDR</option>
                            <option value="mirisdr">MiriSDR</option>
                            <option value="file">File Input</option>
                        </select>
                    </div>
                    
                    <!-- SoapySDR Specific Fields -->
                    <div id="soapysdr-fields" class="device-type-fields">
                        <div class="form-group">
                            <label>Device String *</label>
                            <input type="text" id="device-string" name="device_string" placeholder="driver=airspy">
                            <small>Comma-separated variable=value pairs (e.g., driver=airspy,device_id=0). Use SoapySDRUtil to find your device.</small>
                        </div>
                        <div class="form-group">
                            <label>Gain</label>
                            <input type="text" id="device-gain" name="gain" placeholder="LNA=12,MIX=10,VGA=10">
                            <small>Numeric value (e.g., 25.0) or component format (e.g., LNA=15,MIX=15,VGA=5). If not specified, AGC is enabled. Use SoapySDRUtil to find gain components.</small>
                        </div>
                        <div class="form-group">
                            <label>RF Channel Index</label>
                            <input type="number" id="device-channel" name="channel" min="0" value="0" placeholder="0">
                            <small>For devices with multiple RF channels. Default: 0</small>
                        </div>
                        <div class="form-group">
                            <label>Antenna</label>
                            <input type="text" id="device-antenna" name="antenna" placeholder="RX">
                            <small>Antenna selection. Use SoapySDRUtil --args="device_string" --antenna to see available antennas.</small>
                        </div>
                    </div>
                    
                    <!-- RTL-SDR Specific Fields -->
                    <div id="rtlsdr-fields" class="device-type-fields" style="display: none;">
                        <div class="form-group">
                            <label>Device Index</label>
                            <input type="number" id="device-index" name="index" min="0" placeholder="0">
                            <small>USB device index (0-based). Required if serial is not specified.</small>
                        </div>
                        <div class="form-group">
                            <label>Device Serial Number</label>
                            <input type="text" id="device-serial" name="serial" placeholder="00000001">
                            <small>Device serial number. More reliable than index. Required if index is not specified. Use rtl_test or rtl_eeprom to find serial numbers.</small>
                        </div>
                        <div class="form-group">
                            <label>Gain (dB) *</label>
                            <input type="number" id="device-gain-rtl" name="gain" step="0.1" min="0" max="49.6" placeholder="25.0" required>
                            <small>RF gain in dB. Typical range: 0-49.6 dB in 0.1 dB steps.</small>
                        </div>
                        <div class="form-group">
                            <label>USB Buffers</label>
                            <input type="number" id="device-buffers" name="buffers" min="1" value="15" placeholder="15">
                            <small>Number of USB buffers. Default: 15. More buffers can reduce dropouts but use more memory.</small>
                        </div>
                    </div>
                    
                    <!-- MiriSDR Specific Fields -->
                    <div id="mirisdr-fields" class="device-type-fields" style="display: none;">
                        <div class="form-group">
                            <label>Device Index</label>
                            <input type="number" id="device-index-miri" name="index" min="0" placeholder="0">
                            <small>USB device index (0-based). Required if serial is not specified.</small>
                        </div>
                        <div class="form-group">
                            <label>Device Serial Number</label>
                            <input type="text" id="device-serial-miri" name="serial" placeholder="00000001">
                            <small>Device serial number. More reliable than index. Required if index is not specified.</small>
                        </div>
                        <div class="form-group">
                            <label>Gain (dB) *</label>
                            <input type="number" id="device-gain-miri" name="gain" min="0" placeholder="0" required>
                            <small>RF gain in dB. Required.</small>
                        </div>
                        <div class="form-group">
                            <label>Number of Buffers</label>
                            <input type="number" id="device-num-buffers" name="num_buffers" min="1" placeholder="Default">
                            <small>Number of libUSB buffers. Default: device-specific.</small>
                        </div>
                    </div>
                    
                    <!-- File Input Specific Fields -->
                    <div id="file-fields" class="device-type-fields" style="display: none;">
                        <div class="form-group">
                            <label>File Path *</label>
                            <input type="text" id="device-filepath" name="filepath" placeholder="/path/to/file.cf32">
                            <small>Path to the input file (for testing/playback).</small>
                        </div>
                        <div class="form-group">
                            <label>Speedup Factor</label>
                            <input type="number" id="device-speedup" name="speedup_factor" step="0.1" min="0.1" value="4.0" placeholder="4.0">
                            <small>Playback speed multiplier. Default: 4.0. Set to 0.0 for real-time playback.</small>
                        </div>
                    </div>
                    
                    <!-- Common Device Fields -->
                    <div style="border-top: 2px solid #e0e0e0; padding-top: 20px; margin-top: 20px;">
                        <h3>Common Settings</h3>
                        <div class="form-group">
                            <label>Mode</label>
                            <select id="device-mode" name="mode" onchange="toggleCenterFreq()">
                                <option value="multichannel">Multichannel</option>
                                <option value="scan">Scan</option>
                            </select>
                            <small>Default: multichannel. In multichannel mode, all channels are monitored simultaneously. In scan mode, device scans through frequencies.</small>
                        </div>
                        <div class="form-group" id="centerfreq-group">
                            <label>Center Frequency (MHz) *</label>
                            <input type="number" id="device-centerfreq" name="centerfreq" step="0.001" placeholder="120.0">
                            <small>Required for multichannel mode. Center frequency around which all channels are monitored. Can be specified as MHz (e.g., 120.0) or Hz (e.g., 120000000).</small>
                        </div>
                        <div class="form-group">
                            <label>Sample Rate</label>
                            <input type="text" id="device-sample-rate" name="sample_rate" placeholder="2.56">
                            <small>Sample rate in samples per second. Can be specified as integer Hz (e.g., 2560000), float MHz (e.g., 2.56), or string with unit (e.g., "2.56M"). Default: device-specific (typically 2.56 Msps for RTL-SDR).</small>
                        </div>
                        <div class="form-group">
                            <label>Frequency Correction (PPM)</label>
                            <input type="number" id="device-correction" name="correction" step="0.1" value="0" placeholder="0">
                            <small>PPM (parts per million) frequency correction to compensate for crystal oscillator drift. Use kalibrate-rtl or similar tools to determine the correction value. Default: 0</small>
                        </div>
                        <div class="form-group" id="tau-group" style="display: none;">
                            <label>Tau (NFM De-emphasis, microseconds)</label>
                            <input type="number" id="device-tau" name="tau" min="0" value="200" placeholder="200">
                            <small>Time constant for NFM de-emphasis filter in microseconds. Default: 200 (0.2ms). Value of 0 disables the filter. Only available when compiled with NFM support.</small>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button type="submit" class="btn btn-success">Save Device Configuration</button>
                        <button type="button" class="btn" onclick="loadDevice()" style="background: #6c757d; color: white;">Reload Current Config</button>
                    </div>
                    <input type="hidden" id="device-edit-mode" name="edit_mode" value="false">
                    <input type="hidden" id="device-index-value" name="device_index" value="0">
                </form>
            </div>
        </div>
        <div id="page-channels" class="page hidden">
            <div class="card">
                <h2>Channels</h2>
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-success" onclick="showAddChannelModal()">+ Add Channel</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ENABLE</th>
                            <th>NAME</th>
                            <th>FREQUENCY</th>
                            <th>MODULATION</th>
                            <th>SQUELCH</th>
                            <th>RECORDING</th>
                            <th>STREAMING</th>
                            <th>CONTINUOUS</th>
                            <th>ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody id="channels-list-tbody"></tbody>
                </table>
            </div>
        </div>
        
        <!-- Channel Add/Edit Modal -->
        <div id="channel-modal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
            <div class="modal-content" style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 800px; border-radius: 8px; max-height: 90vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 id="modal-title">Add Channel</h2>
                    <span class="close" onclick="closeChannelModal()" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
                </div>
                <form id="channel-form" onsubmit="saveChannel(event)">
                    <!-- Tab Navigation -->
                    <div style="border-bottom: 2px solid #e0e0e0; margin-bottom: 20px;">
                        <button type="button" class="tab-button active" onclick="showChannelTab('general')" id="tab-general-btn">General</button>
                        <button type="button" class="tab-button" onclick="showChannelTab('outputs')" id="tab-outputs-btn">Outputs</button>
                        <button type="button" class="tab-button" onclick="showChannelTab('advanced')" id="tab-advanced-btn">Advanced</button>
                        <button type="button" class="btn" onclick="resetChannelToDefaults()" style="float: right; background: #6c757d; color: white; margin-left: 10px;">Default</button>
                    </div>
                    
                    <!-- General Tab -->
                    <div id="tab-general" class="channel-tab-content">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>Channel Name/Label *</label>
                                <input type="text" id="channel-label" name="label" required placeholder="e.g., NOAA 162.400">
                            </div>
                            <div class="form-group">
                                <label>Frequency (MHz) *</label>
                                <input type="number" id="channel-freq" name="freq" step="0.001" required placeholder="162.400">
                            </div>
                            <div class="form-group">
                                <label>Modulation *</label>
                                <select id="channel-modulation" name="modulation" required>
                                    <option value="am">AM</option>
                                    <option value="nfm">NFM</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label><input type="checkbox" id="channel-enabled" name="enabled" checked> Channel Enabled</label>
                            </div>
                            
                            <!-- Squelch Settings -->
                            <div class="form-group">
                                <label>Squelch Threshold (dBFS)</label>
                                <input type="number" id="channel-squelch-threshold" name="squelch_threshold" step="0.1" placeholder="0 (auto)">
                                <small>0 = auto, negative values only</small>
                            </div>
                            <div class="form-group">
                                <label>Squelch SNR Threshold (dB)</label>
                                <input type="number" id="channel-squelch-snr" name="squelch_snr_threshold" step="0.1" placeholder="0 (disabled)">
                                <small>0 = disabled, -1 = use default</small>
                            </div>
                            <div class="form-group">
                                <label>CTCSS Tone (Hz)</label>
                                <input type="number" id="channel-ctcss" name="ctcss" step="0.1" placeholder="0 (disabled)">
                                <small>Sub-audible tone frequency</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Outputs Tab -->
                    <div id="tab-outputs" class="channel-tab-content" style="display: none;">
                        <h3>Outputs</h3>
                        
                        <!-- File Output (Recording) -->
                        <div style="background: #f8f8f8; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <label><input type="checkbox" id="output-file-enabled" name="output_file_enabled" checked onchange="toggleOutputSection('file')"> Enable File Recording</label>
                            </div>
                            <div id="output-file-section" style="display: none;">
                                <div class="form-group">
                                    <label>Directory *</label>
                                    <input type="text" id="output-file-directory" name="output_file_directory" placeholder="recordings">
                                </div>
                                <div class="form-group">
                                    <label>Filename Template *</label>
                                    <input type="text" id="output-file-filename" name="output_file_filename" placeholder="Channel_Name">
                                </div>
                                <div class="form-group">
                                    <label><input type="checkbox" id="output-file-continuous" name="output_file_continuous"> Continuous Recording</label>
                                    <small>Record even when squelch is closed</small>
                                </div>
                                <div class="form-group">
                                    <label><input type="checkbox" id="output-file-split" name="output_file_split"> Split on Transmission</label>
                                    <small>Create new file when squelch opens</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- UDP Stream Output -->
                        <div style="background: #f8f8f8; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <label><input type="checkbox" id="output-udp-enabled" name="output_udp_enabled" onchange="toggleOutputSection('udp')"> Enable UDP Streaming</label>
                            </div>
                            <div id="output-udp-section" style="display: none;">
                                <div class="form-group">
                                    <label>Destination Address *</label>
                                    <input type="text" id="output-udp-address" name="output_udp_address" placeholder="127.0.0.1">
                                </div>
                                <div class="form-group">
                                    <label>Destination Port *</label>
                                    <input type="number" id="output-udp-port" name="output_udp_port" placeholder="6001">
                                </div>
                                <div class="form-group">
                                    <label><input type="checkbox" id="output-udp-continuous" name="output_udp_continuous"> Continuous Streaming</label>
                                    <small>Stream even when squelch is closed</small>
                                </div>
                                <div class="form-group">
                                    <label><input type="checkbox" id="output-udp-headers" name="output_udp_headers"> Enable UDP Packet Headers</label>
                                    <small>Include channel metadata (ID, frequency, signal strength, SNR) in each UDP packet</small>
                                </div>
                                <div class="form-group">
                                    <label><input type="checkbox" id="output-udp-chunking" name="output_udp_chunking" checked> Enable MTU-Based Chunking</label>
                                    <small>Split large packets to avoid fragmentation (enabled by default for optimal performance)</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Icecast Output -->
                        <div style="background: #f8f8f8; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <label><input type="checkbox" id="output-icecast-enabled" name="output_icecast_enabled" onchange="toggleOutputSection('icecast')"> Enable Icecast Streaming</label>
                            </div>
                            <div id="output-icecast-section" style="display: none;">
                                <div class="form-group">
                                    <label>Server *</label>
                                    <input type="text" id="output-icecast-server" name="output_icecast_server" placeholder="icecast.example.com">
                                </div>
                                <div class="form-group">
                                    <label>Port *</label>
                                    <input type="number" id="output-icecast-port" name="output_icecast_port" placeholder="8000">
                                </div>
                                <div class="form-group">
                                    <label>Mountpoint *</label>
                                    <input type="text" id="output-icecast-mountpoint" name="output_icecast_mountpoint" placeholder="/stream.mp3">
                                </div>
                                <div class="form-group">
                                    <label>Username *</label>
                                    <input type="text" id="output-icecast-username" name="output_icecast_username" placeholder="source">
                                </div>
                                <div class="form-group">
                                    <label>Password *</label>
                                    <input type="password" id="output-icecast-password" name="output_icecast_password" placeholder="password" autocomplete="current-password">
                                </div>
                                <div class="form-group">
                                    <label>Stream Name</label>
                                    <input type="text" id="output-icecast-name" name="output_icecast_name" placeholder="Channel Name">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Advanced Tab -->
                    <div id="tab-advanced" class="channel-tab-content" style="display: none;">
                        <h3>Advanced Settings</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>Highpass Filter (Hz)</label>
                                <input type="number" id="channel-highpass" name="highpass" value="100" placeholder="100">
                                <small>Default: 100 Hz</small>
                            </div>
                            <div class="form-group">
                                <label>Lowpass Filter (Hz)</label>
                                <input type="number" id="channel-lowpass" name="lowpass" value="2500" placeholder="2500">
                                <small>Default: 2500 Hz</small>
                            </div>
                            <div class="form-group">
                                <label>Bandwidth (Hz)</label>
                                <input type="number" id="channel-bandwidth" name="bandwidth" value="5000" placeholder="5000">
                                <small>For NFM, typically 5000 Hz</small>
                            </div>
                            <div class="form-group">
                                <label>Amplification Factor</label>
                                <input type="number" id="channel-ampfactor" name="ampfactor" step="0.1" value="1.0" placeholder="1.0">
                                <small>Default: 1.0</small>
                            </div>
                            <div class="form-group">
                                <label>AFC (Auto Frequency Control)</label>
                                <input type="number" id="channel-afc" name="afc" min="0" max="255" value="0" placeholder="0">
                                <small>0 = disabled, 1-255 = sensitivity</small>
                            </div>
                            <div class="form-group">
                                <label>Notch Filter Frequency (Hz)</label>
                                <input type="number" id="channel-notch" name="notch" step="0.1" placeholder="0 (disabled)">
                                <small>Remove specific frequency (e.g., 60 Hz hum)</small>
                            </div>
                            <div class="form-group">
                                <label>Notch Filter Q Factor</label>
                                <input type="number" id="channel-notch-q" name="notch_q" step="0.1" value="10.0" placeholder="10.0">
                                <small>Default: 10.0</small>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="btn" onclick="closeChannelModal()" style="background: #6c757d; color: white;">Cancel</button>
                        <button type="submit" class="btn btn-success">Save Channel</button>
                    </div>
                    <input type="hidden" id="channel-device-index" name="device_index" value="0">
                    <input type="hidden" id="channel-index" name="channel_index" value="">
                    <input type="hidden" id="channel-edit-mode" name="edit_mode" value="false">
                </form>
            </div>
        </div>
        <div id="page-outputs" class="page hidden">
            <div class="card">
                <h2>Output Settings</h2>
                <form id="output-form" onchange="markChange('outputs')">
                    <div style="border-bottom: 2px solid #e0e0e0; padding-bottom: 20px; margin-bottom: 20px;">
                        <h3>File Recording Chunking</h3>
                        <div class="form-group">
                            <label>Audio File Chunk Duration: <span id="chunk-duration-value">60</span> minutes</label>
                            <input type="range" id="file-chunk-duration" name="file_chunk_duration_minutes" 
                                   min="5" max="60" step="5" value="60" 
                                   oninput="document.getElementById('chunk-duration-value').textContent = this.value; markChange('outputs');"
                                   style="width: 100%; margin-top: 10px;">
                            <small>Controls how long each audio file chunk will be before creating a new file. Range: 5-60 minutes in 5-minute increments. Default: 60 minutes. This setting applies globally to all channels.</small>
                        </div>
                    </div>
                    <div style="border-top: 2px solid #e0e0e0; padding-top: 20px;">
                        <h3>File Output (Legacy)</h3>
                        <div class="form-group">
                            <label><input type="checkbox" id="file-output-enabled"> Enable File Output</label>
                        </div>
                        <div class="form-group">
                            <label>Directory: *</label>
                            <input type="text" id="output-directory" name="directory" placeholder="recordings/">
                            <small>Directory where audio files will be stored. Must exist. Default: recordings/ (relative to current directory).</small>
                        </div>
                        <div class="form-group">
                            <label>Filename Template: *</label>
                            <input type="text" id="output-filename" name="filename_template" placeholder="Channel">
                            <small>File name prefix. Date and time will be appended automatically.</small>
                        </div>
                    </div>
                    <button type="button" class="btn btn-success" onclick="saveOutputSettings()">Save Output Settings</button>
                </form>
            </div>
        </div>
        <div id="page-spectrum" class="page hidden" style="margin: 0; padding: 0; max-width: 100%;">
            <div class="card" style="margin: 0; padding: 0; border-radius: 0; box-shadow: none;">
                <!-- Main Display Sections: Spectrum and Waterfall -->
                <div style="background: #000; border: none; border-radius: 0; padding: 0; margin-bottom: 0;">
                    <canvas id="spectrum-canvas" width="1200" height="200" style="width: 100%; height: 200px; display: block;"></canvas>
                </div>
                <div style="background: #000; border: none; border-radius: 0; padding: 0; position: relative; margin-bottom: 0;">
                    <canvas id="waterfall-canvas" width="1200" height="300" style="width: 100%; height: 300px; display: block;"></canvas>
                    <!-- Status labels overlay on waterfall -->
                    <div id="waterfall-status-labels" style="position: absolute; bottom: 10px; right: 10px; color: #fff; font-family: monospace; font-size: 12px; background: rgba(0, 0, 0, 0.7); padding: 8px 12px; border-radius: 4px; pointer-events: none;">
                        <div id="waterfall-center-freq">Center: --</div>
                        <div id="waterfall-sample-rate">Sample Rate: --</div>
                        <div id="waterfall-updated">Updated: --</div>
                    </div>
                </div>
                
                <!-- Bottom Controls Section -->
                <div style="margin-top: 0; padding: 20px; display: flex; gap: 20px; align-items: flex-start; background: white;">
                    <!-- Device Selection -->
                    <div style="flex: 0 0 250px;">
                        <label for="spectrum-device-select" style="display: block; margin-bottom: 5px; font-weight: 500;">Device:</label>
                        <select id="spectrum-device-select" style="width: 100%; padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">Loading...</option>
                        </select>
                        <label style="display: block; margin-top: 10px; font-weight: 500;">
                            <input type="checkbox" id="spectrum-auto-update" checked> Auto Update
                        </label>
                    </div>
                    
                    <!-- Display Controls (Collapsible) -->
                    <div style="flex: 1;">
                        <div style="background: #f8f8f8; padding: 15px; border-radius: 4px;">
                            <h3 style="margin: 0 0 15px 0; font-size: 16px; cursor: pointer; user-select: none;" onclick="toggleDisplayControls()">
                                Display Controls <span id="display-controls-arrow">▼</span>
                            </h3>
                            <div id="display-controls-content" style="display: none;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                    <div>
                                        <label for="spectrum-gain" style="display: block; margin-bottom: 5px; font-size: 13px;">
                                            Gain/Intensity: <span id="spectrum-gain-value">-40</span> dB
                                        </label>
                                        <input type="range" id="spectrum-gain" min="-40" max="40" value="-40" step="1" 
                                               style="width: 100%;" oninput="updateSpectrumGain(this.value)">
                                    </div>
                                    <div>
                                        <label for="spectrum-vertical-scale" style="display: block; margin-bottom: 5px; font-size: 13px;">
                                            Vertical Scale: <span id="spectrum-vertical-scale-value">70</span> dB
                                        </label>
                                        <input type="range" id="spectrum-vertical-scale" min="40" max="200" value="70" step="10" 
                                               style="width: 100%;" oninput="updateSpectrumVerticalScale(this.value)">
                                    </div>
                                    <div>
                                        <label for="spectrum-vertical-offset" style="display: block; margin-bottom: 5px; font-size: 13px;">
                                            Vertical Offset: <span id="spectrum-vertical-offset-value">35</span> dB
                                        </label>
                                        <input type="range" id="spectrum-vertical-offset" min="-60" max="60" value="35" step="5" 
                                               style="width: 100%;" oninput="updateSpectrumVerticalOffset(this.value)">
                                    </div>
                                    <div>
                                        <label for="spectrum-averaging" style="display: block; margin-bottom: 5px; font-size: 13px;">
                                            Averaging: <span id="spectrum-averaging-value">10</span>
                                        </label>
                                        <input type="range" id="spectrum-averaging" min="1" max="64" value="10" step="1" 
                                               style="width: 100%;" oninput="updateSpectrumAveraging(this.value)">
                                    </div>
                                    <div>
                                        <label for="waterfall-intensity" style="display: block; margin-bottom: 5px; font-size: 13px;">
                                            Waterfall Sensitivity: <span id="waterfall-intensity-value">50</span>%
                                        </label>
                                        <input type="range" id="waterfall-intensity" min="10" max="100" value="50" step="5" 
                                               style="width: 100%;" oninput="updateWaterfallIntensity(this.value)">
                                        <small style="display: block; margin-top: 3px; font-size: 11px; color: #666;">
                                            Lower = only strong signals, Higher = weak signals visible
                                        </small>
                                    </div>
                                    <div>
                                        <label for="waterfall-speed" style="display: block; margin-bottom: 5px; font-size: 13px;">
                                            Waterfall Speed: <span id="waterfall-speed-value">1</span>x
                                        </label>
                                        <input type="range" id="waterfall-speed" min="1" max="10" value="1" step="1" 
                                               style="width: 100%;" oninput="updateWaterfallSpeed(this.value)">
                                    </div>
                                </div>
                                <div style="margin-top: 15px; display: flex; gap: 10px;">
                                    <button class="btn btn-primary" onclick="resetSpectrumControls()" style="font-size: 12px; padding: 5px 15px;">Reset to Defaults</button>
                                    <button class="btn btn-primary" onclick="clearWaterfall()" style="font-size: 12px; padding: 5px 15px;">Clear Waterfall</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="page-config" class="page hidden">
            <div class="card">
                <h2>Configuration File Management</h2>
                <div class="form-group">
                    <label>Configuration File Path</label>
                    <input type="text" id="config-path" name="config_path" placeholder="/usr/local/etc/boondock_airband.conf" onchange="markChange('config')">
                    <small>Path to the configuration file. Changes require application restart.</small>
                </div>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="loadConfigInfo()">Load Current Path</button>
                    <button class="btn btn-success" onclick="saveConfigPath()" style="margin-left: 10px;">Save Path</button>
                </div>
                <div style="border-top: 1px solid #e0e0e0; padding-top: 20px; margin-top: 20px;">
                    <h3>Download Configuration</h3>
                    <p>Download the current configuration file to your computer.</p>
                    <button class="btn btn-primary" onclick="downloadConfig()">Download Config</button>
                </div>
                <div style="border-top: 1px solid #e0e0e0; padding-top: 20px; margin-top: 20px;">
                    <h3>Upload Configuration</h3>
                    <p>Upload a new configuration file to replace the current one.</p>
                    <input type="file" id="config-upload" accept=".conf,.txt" style="margin-bottom: 10px;" onchange="markChange('config')">
                    <br>
                    <button class="btn btn-success" onclick="uploadConfig()">Upload Config</button>
                    <div id="config-upload-status" style="margin-top: 10px; padding: 10px; border-radius: 4px; display: none;"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="footer" style="background: white; padding: 20px; margin-top: 40px; border-top: 1px solid #e0e0e0; text-align: center; color: #666;">
        <p>Copyright &copy; Boondock Technologies 2026 | <a href="https://www.boondockecho.com" target="_blank" style="color: #0066cc; text-decoration: none;">www.boondockecho.com</a></p>
    </div>
    <script src="/web_ui.js"></script>
    <script src="/web_spectrum.js"></script>
</body>
</html>
